{
  "gitSyncId": "68f1ea66301c3b6f3e13c5f4_3ed5a42b-1457-4f2f-8d86-eeef96353cdc",
  "id": "Dashboard_q_movimientos_dia",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH p AS (\n  SELECT\n    {{ appsmith.store.businessId }}::uuid AS bid,\n    {{ moment(DateDia.selectedDate || new Date()).format('YYYY-MM-DD') }}::date AS d\n),\n\n-- ðŸ”¹ Visitas del dÃ­a (con servicio y precio desde StaffServiceLog vÃ­a visitId)\nvis AS (\n  SELECT\n    v.\"visitedAt\"                                      AS at,\n    to_char(v.\"visitedAt\", 'YYYY-MM-DD')               AS fecha,\n    to_char(v.\"visitedAt\", 'HH24:MI')                  AS hora,\n    'VISITA'                                           AS kind,\n    c.id                                               AS \"customerId\",\n    c.name                                             AS \"customerName\",\n    sl.\"serviceName\"                                   AS details,\n    COALESCE(sl.\"priceCents\", 0)::int                  AS amount_cents\n  FROM \"Visit\" v\n  JOIN \"Customer\" c\n    ON c.id = v.\"customerId\"\n  JOIN p ON TRUE\n  LEFT JOIN \"StaffServiceLog\" sl\n    ON sl.\"businessId\" = p.bid\n   AND sl.\"visitId\"    = v.id          -- ðŸ‘ˆ emparejamos por visitId, robusto\n  WHERE c.\"businessId\" = p.bid\n    AND c.\"deletedAt\" IS NULL\n    AND v.\"visitedAt\"::date = p.d\n),\n\n-- ðŸ”¹ Nuevos clientes\nnc AS (\n  SELECT\n    c.\"createdAt\"                                     AS at,\n    to_char(c.\"createdAt\", 'YYYY-MM-DD')              AS fecha,\n    to_char(c.\"createdAt\", 'HH24:MI')                 AS hora,\n    'NUEVO CLIENTE'                                   AS kind,\n    c.id                                              AS \"customerId\",\n    c.name                                            AS \"customerName\",\n    NULL::text                                        AS details,\n    NULL::int                                         AS amount_cents\n  FROM \"Customer\" c\n  JOIN p ON TRUE\n  WHERE c.\"businessId\" = p.bid\n    AND c.\"deletedAt\" IS NULL\n    AND c.\"createdAt\"::date = p.d\n),\n\n-- ðŸ”¹ Pagos de bono\nbp AS (\n  SELECT\n    bp.\"paidAt\"                                       AS at,\n    to_char(bp.\"paidAt\", 'YYYY-MM-DD')                AS fecha,\n    to_char(bp.\"paidAt\", 'HH24:MI')                   AS hora,\n    'PAGO BONO'                                       AS kind,\n    c.id                                              AS \"customerId\",\n    c.name                                            AS \"customerName\",\n    ('Pago de bono ' || b.id)::text                  AS details,\n    COALESCE(bp.\"amountCents\", 0)::int               AS amount_cents\n  FROM \"BondPayment\" bp\n  JOIN \"Bond\" b     ON b.id = bp.\"bondId\"\n  JOIN \"Customer\" c ON c.id = b.\"customerId\"\n  JOIN p ON TRUE\n  WHERE c.\"businessId\" = p.bid\n    AND c.\"deletedAt\" IS NULL\n    AND bp.\"paidAt\"::date = p.d\n)\n\n-- ðŸ”¹ Consolida (todas tienen 8 columnas)\nSELECT\n  at,\n  fecha,\n  hora,\n  kind,\n  \"customerId\",\n  \"customerName\",\n  details,\n  amount_cents,\n  ROUND(COALESCE(amount_cents,0)/100.0, 2)::numeric(12,2) AS amount_eur\nFROM (\n  SELECT * FROM vis\n  UNION ALL\n  SELECT * FROM nc\n  UNION ALL\n  SELECT * FROM bp\n) t\nORDER BY\n  CASE WHEN {{ (appsmith.store.mov_sort_dir || 'DESC') === 'ASC' }}\n       THEN at END ASC,\n  CASE WHEN {{ (appsmith.store.mov_sort_dir || 'DESC') !== 'ASC' }}\n       THEN at END DESC,\n  \"customerName\";\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "AxiomaDB",
      "isAutoGenerated": false,
      "name": "AxiomaDB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "q_movimientos_dia",
    "pageId": "Dashboard",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}