{
  "gitSyncId": "68f1ea66301c3b6f3e13c5f4_3ed5a42b-1457-4f2f-8d86-eeef96353cdc",
  "id": "Dashboard_q_movimientos_dia",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH p AS (\n  SELECT\n    {{ appsmith.store.businessId }}::uuid AS bid,\n    {{ moment(DateDia.selectedDate || new Date()).format('YYYY-MM-DD') }}::date AS d\n),\n\n-- üîπ Visitas del d√≠a\nvis AS (\n  SELECT\n    v.\"visitedAt\"                   AS at,\n    'VISITA'                        AS kind,\n    c.id                            AS \"customerId\",\n    c.name                          AS \"customerName\",\n    NULL::text                      AS details,\n    NULL::int                       AS amount_cents\n  FROM \"Visit\" v\n  JOIN \"Customer\" c ON c.id = v.\"customerId\"\n  JOIN p ON TRUE\n  WHERE c.\"businessId\" = p.bid\n    AND c.\"deletedAt\" IS NULL\n    AND v.\"visitedAt\"::date = p.d\n),\n\n-- üîπ Nuevos clientes del d√≠a\nnc AS (\n  SELECT\n    c.\"createdAt\"                   AS at,\n    'NUEVO CLIENTE'                 AS kind,\n    c.id                            AS \"customerId\",\n    c.name                          AS \"customerName\",\n    NULL::text                      AS details,\n    NULL::int                       AS amount_cents\n  FROM \"Customer\" c\n  JOIN p ON TRUE\n  WHERE c.\"businessId\" = p.bid\n    AND c.\"deletedAt\" IS NULL\n    AND c.\"createdAt\"::date = p.d\n),\n\n-- üîπ Pagos de bonos del d√≠a\nbp AS (\n  SELECT\n    bp.\"paidAt\"                     AS at,\n    'PAGO BONO'                     AS kind,\n    c.id                            AS \"customerId\",\n    c.name                          AS \"customerName\",\n    ('Pago de bono ' || b.id)::text AS details,\n    COALESCE(bp.\"amountCents\", 0)::int AS amount_cents\n  FROM \"BondPayment\" bp\n  JOIN \"Bond\" b     ON b.\"id\" = bp.\"bondId\"\n  JOIN \"Customer\" c ON c.id   = b.\"customerId\"\n  JOIN p ON TRUE\n  WHERE c.\"businessId\" = p.bid\n    AND c.\"deletedAt\" IS NULL\n    AND bp.\"paidAt\"::date = p.d\n)\n\n-- üîπ Consolidado\nSELECT\n  at,\n  to_char(at, 'YYYY-MM-DD')                 AS fecha,   -- opcional\n  to_char(at, 'HH24:MI')                    AS hora,    -- ‚è∞ hora visible\n  kind,\n  \"customerId\",\n  \"customerName\",\n  details,\n  amount_cents,\n  ROUND(COALESCE(amount_cents,0)/100.0, 2)::numeric(12,2) AS amount_eur\nFROM (\n  SELECT * FROM vis\n  UNION ALL\n  SELECT * FROM nc\n  UNION ALL\n  SELECT * FROM bp\n) t\nORDER BY\n  -- si la UI dice ASC, activa esta rama\n  CASE WHEN {{ (appsmith.store.mov_sort_dir || 'DESC') === 'ASC' }} THEN at END ASC,\n  -- si la UI dice DESC (por defecto), activa esta rama\n  CASE WHEN {{ (appsmith.store.mov_sort_dir || 'DESC') !== 'ASC' }} THEN at END DESC,\n  \"customerName\";\n\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "AxiomaDB",
      "isAutoGenerated": false,
      "name": "AxiomaDB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "q_movimientos_dia",
    "pageId": "Dashboard",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}