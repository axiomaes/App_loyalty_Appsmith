WITH p AS (
  SELECT
    {{ appsmith.store.businessId }}::uuid AS bid,
    {{ moment(DateDia.selectedDate || new Date()).format('YYYY-MM-DD') }}::date AS d
)

SELECT
  COALESCE(l."serviceName", 'Sin servicio') AS service_name,
  COUNT(*)::int                             AS count,
  COALESCE(SUM(l."priceCents"), 0)::int     AS cents,
  ROUND(COALESCE(SUM(l."priceCents"),0)/100.0, 2)::numeric(12,2) AS euros
FROM "StaffServiceLog" l
JOIN p ON TRUE
WHERE l."businessId" = p.bid
  AND l."visitedAt"::date = p.d
GROUP BY COALESCE(l."serviceName", 'Sin servicio')
ORDER BY count DESC, service_name;
