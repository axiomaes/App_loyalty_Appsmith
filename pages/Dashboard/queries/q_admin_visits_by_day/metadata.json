{
  "gitSyncId": "68f1ea66301c3b6f3e13c5f4_9676b21c-6efe-4cc2-a5c4-9949db8b666d",
  "id": "Dashboard_q_admin_visits_by_day",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH p AS (\n  SELECT\n    {{ appsmith.store.businessId }}::uuid AS bid,\n\n    -- ¿el usuario seleccionó fechas?\n    {{ !!DateIni.selectedDate }}::boolean AS has_ini,\n    {{ !!DateFin.selectedDate }}::boolean AS has_fin,\n\n    -- valores (si no hay selección, caen en hoy; no importa porque controlamos abajo)\n    to_date({{ DateIni.selectedDate\n               ? moment(DateIni.selectedDate).format('YYYY-MM-DD')\n               : moment().format('YYYY-MM-DD') }}, 'YYYY-MM-DD') AS d1,\n    to_date({{ DateFin.selectedDate\n               ? moment(DateFin.selectedDate).format('YYYY-MM-DD')\n               : moment().format('YYYY-MM-DD') }}, 'YYYY-MM-DD') AS d2,\n\n    -- \"hoy\" en horario de España\n    (now() AT TIME ZONE 'Europe/Madrid')::date AS today\n),\np2 AS (\n  SELECT\n    bid, d1, d2, today,\n    -- si falta una o ambas fechas -> usar solo hoy\n    ((NOT has_ini) OR (NOT has_fin)) AS today_only\n  FROM p\n),\n\nvis AS (\n  SELECT COUNT(*)::int AS visits\n  FROM compat.visits v\n  JOIN \"Customer\" c ON c.id = v.\"customerId\"\n  JOIN p2 ON TRUE\n  WHERE c.\"businessId\" = p2.bid\n    AND (\n      CASE\n        WHEN p2.today_only\n          THEN (v.\"visitedAt\" AT TIME ZONE 'Europe/Madrid')::date = p2.today\n        ELSE (v.\"visitedAt\" AT TIME ZONE 'Europe/Madrid')::date\n             BETWEEN LEAST(p2.d1, p2.d2) AND GREATEST(p2.d1, p2.d2)\n      END\n    )\n),\n\nnc AS (\n  -- SIEMPRE solo hoy (España)\n  SELECT COUNT(*)::int AS new_customers\n  FROM compat.customers c\n  JOIN p2 ON TRUE\n  WHERE c.\"businessId\" = p2.bid\n    AND c.\"deletedAt\" IS NULL\n    AND (c.\"createdAt\" AT TIME ZONE 'Europe/Madrid')::date = p2.today\n),\n\nbp AS (\n  SELECT\n    COUNT(*)::int AS bond_payments,\n    COALESCE(SUM(bp.\"amountCents\"), 0)::bigint AS cents\n  FROM compat.bond_payment bp\n  JOIN p2 ON TRUE\n  WHERE bp.\"businessId\" = p2.bid\n    AND (\n      CASE\n        WHEN p2.today_only\n          THEN (bp.\"paidAt\" AT TIME ZONE 'Europe/Madrid')::date = p2.today\n        ELSE (bp.\"paidAt\" AT TIME ZONE 'Europe/Madrid')::date\n             BETWEEN LEAST(p2.d1, p2.d2) AND GREATEST(p2.d1, p2.d2)\n      END\n    )\n)\n\nSELECT\n  (SELECT visits        FROM vis) AS visits,\n  (SELECT new_customers FROM nc ) AS new_customers,\n  (SELECT bond_payments FROM bp ) AS bond_payments,\n  (SELECT cents         FROM bp ) AS amount_cents;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "AxiomaDB",
      "isAutoGenerated": false,
      "name": "AxiomaDB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "q_admin_visits_by_day",
    "pageId": "Dashboard",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}