{
  "gitSyncId": "68f1ea66301c3b6f3e13c5f4_9676b21c-6efe-4cc2-a5c4-9949db8b666d",
  "id": "Dashboard_q_admin_visits_by_day",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH p AS (\n\tSELECT\n\t{{ appsmith.store.businessId }}::uuid AS bid,\n\n\t-- 쯘l usuario seleccion칩 fechas?\n\t{{ !!DateIni.selectedDate }}::boolean AS has_ini,\n\t{{ !!DateFin.selectedDate }}::boolean AS has_fin,\n\n\t-- valores (si no hay selecci칩n, caen en hoy; no importa porque controlamos abajo)\n\tto_date({{ DateIni.selectedDate\n\t\t? moment(DateIni.selectedDate).format('YYYY-MM-DD')\n\t\t: moment().format('YYYY-MM-DD') }}, 'YYYY-MM-DD') AS d1,\n\tto_date({{ DateFin.selectedDate\n\t\t? moment(DateFin.selectedDate).format('YYYY-MM-DD')\n\t\t: moment().format('YYYY-MM-DD') }}, 'YYYY-MM-DD') AS d2,\n\n\t-- \"hoy\" en horario de Espa침a\n\t(now() AT TIME ZONE 'Europe/Madrid')::date AS today\n),\np2 AS (\n\tSELECT\n\tbid, d1, d2, today,\n\t-- si falta una o ambas fechas -> usar solo hoy\n\t((NOT has_ini) OR (NOT has_fin)) AS today_only\n\tFROM p\n),\n\n-- 游댳 TOTAL SERVICIOS (StaffServiceLog)\nsvc AS (\n\tSELECT COUNT(*)::int AS services\n\tFROM \"StaffServiceLog\" l\n\tJOIN \"Customer\" c ON c.id = l.\"customerId\"\n\tJOIN p2 ON TRUE\n\tWHERE c.\"businessId\" = p2.bid\n\tAND c.\"deletedAt\" IS NULL\n\tAND (\n\t\tCASE\n\t\tWHEN p2.today_only\n\t\tTHEN (l.\"visitedAt\" AT TIME ZONE 'Europe/Madrid')::date = p2.today\n\t\tELSE (l.\"visitedAt\" AT TIME ZONE 'Europe/Madrid')::date\n\t\tBETWEEN LEAST(p2.d1, p2.d2) AND GREATEST(p2.d1, p2.d2)\n\t\tEND\n\t)\n),\n\n-- 游댳 NUEVOS CLIENTES (solo hoy Espa침a, igual que antes)\nnc AS (\n\tSELECT COUNT(*)::int AS new_customers\n\tFROM compat.customers c\n\tJOIN p2 ON TRUE\n\tWHERE c.\"businessId\" = p2.bid\n\tAND c.\"deletedAt\" IS NULL\n\tAND (c.\"createdAt\" AT TIME ZONE 'Europe/Madrid')::date = p2.today\n),\n\n-- 游댳 PAGOS DE BONO (igual que antes)\nbp AS (\n\tSELECT\n\tCOUNT(*)::int AS bond_payments,\n\tCOALESCE(SUM(bp.\"amountCents\"), 0)::bigint AS cents\n\tFROM compat.bond_payment bp\n\tJOIN p2 ON TRUE\n\tWHERE bp.\"businessId\" = p2.bid\n\tAND (\n\t\tCASE\n\t\tWHEN p2.today_only\n\t\tTHEN (bp.\"paidAt\" AT TIME ZONE 'Europe/Madrid')::date = p2.today\n\t\tELSE (bp.\"paidAt\" AT TIME ZONE 'Europe/Madrid')::date\n\t\tBETWEEN LEAST(p2.d1, p2.d2) AND GREATEST(p2.d1, p2.d2)\n\t\tEND\n\t)\n)\n\nSELECT\n  -- OJO: 'visits' ahora = total de servicios\n  (SELECT services      FROM svc) AS visits,\n  (SELECT new_customers FROM nc ) AS new_customers,\n  (SELECT bond_payments FROM bp ) AS bond_payments,\n  (SELECT cents         FROM bp ) AS amount_cents;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "AxiomaDB",
      "isAutoGenerated": false,
      "name": "AxiomaDB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "q_admin_visits_by_day",
    "pageId": "Dashboard",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}