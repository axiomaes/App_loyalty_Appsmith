WITH p AS (
	SELECT
	{{ appsmith.store.businessId }}::uuid AS bid,

	-- 쯘l usuario seleccion칩 fechas?
	{{ !!DateIni.selectedDate }}::boolean AS has_ini,
	{{ !!DateFin.selectedDate }}::boolean AS has_fin,

	-- valores (si no hay selecci칩n, caen en hoy; no importa porque controlamos abajo)
	to_date({{ DateIni.selectedDate
		? moment(DateIni.selectedDate).format('YYYY-MM-DD')
		: moment().format('YYYY-MM-DD') }}, 'YYYY-MM-DD') AS d1,
	to_date({{ DateFin.selectedDate
		? moment(DateFin.selectedDate).format('YYYY-MM-DD')
		: moment().format('YYYY-MM-DD') }}, 'YYYY-MM-DD') AS d2,

	-- "hoy" en horario de Espa침a
	(now() AT TIME ZONE 'Europe/Madrid')::date AS today
),
p2 AS (
	SELECT
	bid, d1, d2, today,
	-- si falta una o ambas fechas -> usar solo hoy
	((NOT has_ini) OR (NOT has_fin)) AS today_only
	FROM p
),

-- 游댳 TOTAL SERVICIOS (StaffServiceLog)
svc AS (
	SELECT COUNT(*)::int AS services
	FROM "StaffServiceLog" l
	JOIN "Customer" c ON c.id = l."customerId"
	JOIN p2 ON TRUE
	WHERE c."businessId" = p2.bid
	AND c."deletedAt" IS NULL
	AND (
		CASE
		WHEN p2.today_only
		THEN (l."visitedAt" AT TIME ZONE 'Europe/Madrid')::date = p2.today
		ELSE (l."visitedAt" AT TIME ZONE 'Europe/Madrid')::date
		BETWEEN LEAST(p2.d1, p2.d2) AND GREATEST(p2.d1, p2.d2)
		END
	)
),

-- 游댳 NUEVOS CLIENTES (solo hoy Espa침a, igual que antes)
nc AS (
	SELECT COUNT(*)::int AS new_customers
	FROM compat.customers c
	JOIN p2 ON TRUE
	WHERE c."businessId" = p2.bid
	AND c."deletedAt" IS NULL
	AND (c."createdAt" AT TIME ZONE 'Europe/Madrid')::date = p2.today
),

-- 游댳 PAGOS DE BONO (igual que antes)
bp AS (
	SELECT
	COUNT(*)::int AS bond_payments,
	COALESCE(SUM(bp."amountCents"), 0)::bigint AS cents
	FROM compat.bond_payment bp
	JOIN p2 ON TRUE
	WHERE bp."businessId" = p2.bid
	AND (
		CASE
		WHEN p2.today_only
		THEN (bp."paidAt" AT TIME ZONE 'Europe/Madrid')::date = p2.today
		ELSE (bp."paidAt" AT TIME ZONE 'Europe/Madrid')::date
		BETWEEN LEAST(p2.d1, p2.d2) AND GREATEST(p2.d1, p2.d2)
		END
	)
)

SELECT
  -- OJO: 'visits' ahora = total de servicios
  (SELECT services      FROM svc) AS visits,
  (SELECT new_customers FROM nc ) AS new_customers,
  (SELECT bond_payments FROM bp ) AS bond_payments,
  (SELECT cents         FROM bp ) AS amount_cents;
