WITH v AS (
	SELECT
	{{ appsmith.store.businessId }}::uuid                          AS bid,
	lower(trim({{ this.params.email }}::text))                     AS email_norm,
	{{ this.params.new_pass }}::text                               AS pass_raw,
	upper(trim(COALESCE({{ this.params.role }}::text,'BARBER')))   AS role_raw,
	lower(trim(
		COALESCE({{ this.params.created_by_email }},
						 {{ appsmith.store.userEmail }},
						 {{ appsmith.user.email }},
						 '')
	))                                                             AS created_by_email
),
chk AS (
	SELECT
	(email_norm ~ '^[^@\\s]+@[^@\\s]+\\.[^@\\s]+$') AS ok_email,
	(length(pass_raw) >= 8)                         AS ok_pass,
	(role_raw IN ('BARBER','ADMIN','OWNER','SUPERADMIN')) AS ok_role
	FROM v
),
go AS ( SELECT 1 FROM chk WHERE ok_email AND ok_pass AND ok_role ),

creator AS (
	SELECT u.id AS created_by_id
	FROM "User" u, v
	WHERE u."businessId" = v.bid
	AND lower(u.email) = v.created_by_email
	LIMIT 1
),
ins AS (
	INSERT INTO "User" ("businessId", email, "password", role, "createdBy", "createdByEmail")
	SELECT v.bid, v.email_norm, crypt(v.pass_raw, gen_salt('bf')), v.role_raw,
	c.created_by_id, v.created_by_email
	FROM v
	JOIN go ON TRUE
	LEFT JOIN creator c ON TRUE
	ON CONFLICT ON CONSTRAINT ux_user_email_lower DO NOTHING
	RETURNING id, email, role, "createdBy", "createdByEmail"
)
SELECT
  (SELECT ok_email FROM chk) AS ok_email,
  (SELECT ok_pass  FROM chk) AS ok_pass,
  (SELECT ok_role  FROM chk) AS ok_role,
  EXISTS (SELECT 1 FROM ins) AS inserted,
  EXISTS (
		SELECT 1 FROM "User" u, v
		WHERE lower(u.email) = v.email_norm
		AND u."businessId" = v.bid
	) AS duplicate_email,
  (SELECT to_jsonb(ins.*) FROM ins) AS row;
