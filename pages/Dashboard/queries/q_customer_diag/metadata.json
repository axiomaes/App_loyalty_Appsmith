{
  "gitSyncId": "68f1ea66301c3b6f3e13c5f4_f1953f21-9670-4b5e-8063-46a41120abf6",
  "id": "Dashboard_q_customer_diag",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "-- Params:\n--   this.params.customerId :: uuid (obligatorio)\n\nWITH v AS (\n  SELECT\n    {{ appsmith.store.businessId }}::uuid AS bid,\n    {{ this.params.customerId }}::uuid    AS cid\n),\ncust AS (\n  SELECT c.*\n  FROM \"Customer\" c\n  JOIN v ON c.id = v.cid\n),\nlast_visit AS (\n  SELECT\n    v2.\"customerId\" AS cid,\n    MAX(v2.\"visitedAt\") AS ultima_visita,\n    COUNT(*)::int  AS total_visitas_vida\n  FROM \"Visit\" v2\n  JOIN v ON v.cid = v2.\"customerId\"\n  GROUP BY v2.\"customerId\"\n),\nbond_info AS (\n  SELECT\n    b.\"customerId\" AS cid,\n    b.id           AS bond_id,\n    b.\"planId\"     AS plan_id,\n    b.status       AS bond_status,\n    b.\"startedAt\"  AS bond_started_at,\n    b.\"lastPaidPeriod\" AS last_paid_period\n  FROM \"Bond\" b\n  JOIN v ON v.cid = b.\"customerId\"\n  ORDER BY b.\"startedAt\" DESC\n  LIMIT 1\n),\nplan_info AS (\n  SELECT\n    bp.id   AS plan_id,\n    bp.code AS plan_code,\n    bp.name AS plan_name,\n    bp.\"isActive\" AS plan_active\n  FROM \"BondPlan\" bp\n  JOIN bond_info bi ON bi.plan_id = bp.id\n)\nSELECT\n  c.id                    AS customer_id,\n  c.name                  AS customer_name,\n  c.phone                 AS customer_phone,\n  c.email                 AS customer_email,\n  c.tag                   AS customer_tag,\n  c.\"businessId\"          AS business_id,\n  c.\"createdAt\"           AS customer_created_at,\n  c.\"updatedAt\"           AS customer_updated_at,\n  c.\"deletedAt\"           AS customer_deleted_at,\n\n  /* Flags clave para la v2 */\n  (c.\"businessId\" = (SELECT bid FROM v)) AS matches_current_business,\n  (c.\"deletedAt\" IS NULL)                AS is_not_deleted,\n\n  /* Visitas */\n  lv.ultima_visita,\n  COALESCE(lv.total_visitas_vida,0)      AS total_visitas_vida,\n\n  /* Bono / Plan */\n  bi.bond_id,\n  bi.bond_status,\n  bi.bond_started_at,\n  bi.last_paid_period,\n  pi.plan_code,\n  pi.plan_name,\n  pi.plan_active\n\nFROM cust c\nLEFT JOIN last_visit lv ON lv.cid = c.id\nLEFT JOIN bond_info  bi ON bi.cid = c.id\nLEFT JOIN plan_info  pi ON pi.plan_id = bi.plan_id;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "AxiomaDB",
      "isAutoGenerated": false,
      "name": "AxiomaDB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "q_customer_diag",
    "pageId": "Dashboard",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}