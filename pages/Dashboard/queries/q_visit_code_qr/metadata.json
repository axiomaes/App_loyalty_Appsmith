{
  "gitSyncId": "68f1ea66301c3b6f3e13c5f4_70d1f06b-b7ab-492e-932a-2e1e4aff1e36",
  "id": "Dashboard_q_visit_code_qr",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH input AS (\n  SELECT\n    {{ this.params.customerId }}::uuid        AS customer_id,\n    NULLIF(TRIM({{ this.params.notes || '' }}::text), '') AS notes,\n    ({{ this.params.isAdminLike ? 'true' : 'false' }})::boolean AS is_admin_like,\n    now()::timestamptz AS now_ts\n),\n\n-- Última visita registrada del cliente\nlast_visit AS (\n  SELECT MAX(v.\"visitedAt\") AS last_at\n  FROM \"Visit\" v\n  WHERE v.\"customerId\" = (SELECT customer_id FROM input)\n),\n\n-- Política: permitir si:\n--  1) Es admin-like, o\n--  2) Nunca visitó antes, o\n--  3) Pasaron al menos 48h desde la última\npolicy AS (\n  SELECT\n    i.customer_id,\n    i.notes,\n    i.is_admin_like,\n    i.now_ts,\n    l.last_at,\n    (i.is_admin_like OR l.last_at IS NULL OR i.now_ts - l.last_at >= INTERVAL '48 hours') AS allowed\n  FROM input i\n  LEFT JOIN last_visit l ON TRUE\n),\n\n-- Inserta visita solo si está permitida\nins AS (\n  INSERT INTO \"Visit\"(id, \"customerId\", \"visitedAt\", notes)\n  SELECT\n    uuid_generate_v4(),\n    p.customer_id,\n    p.now_ts,\n    p.notes\n  FROM policy p\n  WHERE p.allowed\n  RETURNING *\n)\n\n-- Resultado para Appsmith\nSELECT\n  (SELECT allowed FROM policy)             AS allowed,\n  (SELECT last_at FROM policy)             AS last_visit,\n  (SELECT COUNT(*) > 0 FROM ins)           AS inserted,\n  (SELECT to_jsonb(ins.*) FROM ins)        AS row;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "AxiomaDB",
      "isAutoGenerated": false,
      "name": "AxiomaDB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "q_visit_code_qr",
    "pageId": "Dashboard",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}