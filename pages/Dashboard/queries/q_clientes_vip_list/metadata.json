{
  "gitSyncId": "68f1ea66301c3b6f3e13c5f4_ff13fc85-a6ee-47ec-a516-54e704a994b8",
  "id": "Dashboard_q_clientes_vip_list",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "-- q_clientes_vip_list\nWITH vars AS (\n  SELECT\n    {{ Auth.businessId() }}::text AS bid,\n    date_trunc('month', now())    AS mstart,\n    to_char(now(), 'YYYY-MM')     AS period\n),\n\n-- Clientes VIP (A/B/C) del negocio actual, no borrados\nc AS (\n  SELECT c.id, c.name, c.phone, c.email, c.tag\n  FROM \"Customer\" c\n  WHERE c.\"deletedAt\" IS NULL\n    AND c.\"businessId\" = (SELECT bid FROM vars)\n    AND c.tag IN ('BONO_VIP_A','BONO_VIP_B','BONO_VIP_C')\n),\n\n-- Visitas del mes por cliente\nvm AS (\n  SELECT v.\"customerId\" AS cid, count(*)::int AS used\n  FROM \"Visit\" v\n  WHERE v.\"visitedAt\" >= (SELECT mstart FROM vars)\n    AND v.\"visitedAt\" <  (SELECT mstart FROM vars) + interval '1 month'\n  GROUP BY v.\"customerId\"\n)\n\nSELECT\n  c.id,\n  c.name,\n  c.phone,\n  c.email,\n  c.tag,\n  -- Estado del bono VIP del mes: pagado (activo) o no\n  COALESCE(bp.id IS NOT NULL, false)              AS vip_active,\n  -- Métricas del mes\n  COALESCE(vm.used, 0)                            AS used_this_month,\n  GREATEST(0, 4 - COALESCE(vm.used, 0))           AS remaining_this_month,\n  -- Info del último pago del mes (si existe)\n  bp.\"paidAt\"                                     AS last_paid_at,\n  bp.\"amountCents\",\n  bp.\"method\",\n  bp.\"notes\"\nFROM c\nLEFT JOIN \"Bond\" b\n  ON b.\"customerId\" = c.id\nLEFT JOIN \"BondPayment\" bp\n  ON bp.\"bondId\" = b.id\n AND bp.period = (SELECT period FROM vars)\nLEFT JOIN vm\n  ON vm.cid = c.id\nORDER BY c.name;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "AxiomaDB",
      "isAutoGenerated": false,
      "name": "AxiomaDB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "q_clientes_vip_list",
    "pageId": "Dashboard",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}