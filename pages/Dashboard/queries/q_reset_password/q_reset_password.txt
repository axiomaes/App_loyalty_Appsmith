WITH v AS (
  SELECT
    {{ appsmith.store.businessId }}::uuid AS bid,
    {{ this.params.user_id }}::uuid       AS uid,
    {{ this.params.new_pass }}::text      AS pass
),
chk AS (
  SELECT (length(pass) >= 8) AS ok_pass FROM v
),
go AS ( SELECT 1 FROM chk WHERE ok_pass ),
upd AS (
  UPDATE "User" u
     SET "password" = crypt((SELECT pass FROM v), gen_salt('bf'))
  FROM v, go
  WHERE u.id = v.uid
    AND u."businessId" = v.bid
  RETURNING u.id, u.email, u.role
)
SELECT
  (SELECT ok_pass FROM chk)            AS ok_pass,
  EXISTS (SELECT 1 FROM upd)           AS updated,
  (SELECT to_jsonb(upd.*) FROM upd)    AS row;
