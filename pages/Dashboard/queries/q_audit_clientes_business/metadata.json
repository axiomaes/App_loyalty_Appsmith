{
  "gitSyncId": "68f1ea66301c3b6f3e13c5f4_b292259f-14db-4740-aaab-f981c65dde55",
  "id": "Dashboard_q_audit_clientes_business",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH p AS (\n  SELECT {{ appsmith.store.businessId }}::uuid AS bid\n),\n-- normalizador básico de móvil\ncust AS (\n  SELECT\n    c.*,\n    REGEXP_REPLACE(c.phone, '\\D', '', 'g') AS phone_norm\n  FROM \"Customer\" c\n  WHERE c.\"businessId\" = (SELECT bid FROM p)\n),\ndup_phones AS (\n  SELECT phone_norm\n  FROM cust\n  WHERE phone_norm IS NOT NULL AND phone_norm <> ''\n  GROUP BY phone_norm\n  HAVING COUNT(*) > 1\n),\nvip_tag AS (\n  SELECT id\n  FROM cust\n  WHERE COALESCE(tag,'') ILIKE '%VIP%'\n),\ncust_bond AS (\n  SELECT DISTINCT b.\"customerId\" AS customer_id, b.id AS bond_id, b.\"planId\" AS plan_id, b.status\n  FROM \"Bond\" b\n  JOIN cust c ON c.id = b.\"customerId\"\n),\nbond_plan AS (\n  SELECT bp.*\n  FROM \"BondPlan\" bp\n)\n-- Incidencias, una por fila\nSELECT\n  'CLIENTE_ELIMINADO'::text            AS issue,\n  c.id                                 AS customer_id,\n  c.name                               AS customer_name,\n  c.tag,\n  c.\"createdAt\",\n  'deletedAt no es NULL'               AS details\nFROM cust c\nWHERE c.\"deletedAt\" IS NOT NULL\n\nUNION ALL\nSELECT\n  'TAG_NULO_O_VACIO',\n  c.id, c.name, c.tag, c.\"createdAt\",\n  'tag es NULL o \"\"'\nFROM cust c\nWHERE c.tag IS NULL OR c.tag = ''\n\nUNION ALL\nSELECT\n  'TELEFONO_DUPLICADO',\n  c.id, c.name, c.tag, c.\"createdAt\",\n  'phone_norm duplicado dentro del negocio'\nFROM cust c\nWHERE c.phone_norm IN (SELECT phone_norm FROM dup_phones)\n\nUNION ALL\nSELECT\n  'VIP_SIN_BONO',\n  c.id, c.name, c.tag, c.\"createdAt\",\n  'Cliente con tag VIP pero sin registro en Bond'\nFROM cust c\nJOIN vip_tag v ON v.id = c.id\nLEFT JOIN cust_bond cb ON cb.customer_id = c.id\nWHERE cb.customer_id IS NULL\n\nUNION ALL\nSELECT\n  'BONO_CON_PLAN_INACTIVO',\n  c.id, c.name, c.tag, c.\"createdAt\",\n  'Bond vinculado a BondPlan.isActive = false'\nFROM cust c\nJOIN cust_bond cb ON cb.customer_id = c.id\nJOIN bond_plan bp ON bp.id = cb.plan_id\nWHERE COALESCE(bp.\"isActive\", TRUE) = FALSE\n\nUNION ALL\nSELECT\n  'BONO_STATUS_NO_ACTIVO',\n  c.id, c.name, c.tag, c.\"createdAt\",\n  'Bond.status ∉ (ACTIVE, OPEN)'\nFROM cust c\nJOIN cust_bond cb ON cb.customer_id = c.id\nWHERE COALESCE(cb.status,'') NOT IN ('ACTIVE','OPEN')\n\nUNION ALL\nSELECT\n  'BONDPLAN_OTRO_NEGOCIO',\n  c.id, c.name, c.tag, c.\"createdAt\",\n  'BondPlan.businessId ≠ Customer.businessId'\nFROM cust c\nJOIN cust_bond cb ON cb.customer_id = c.id\nJOIN bond_plan bp ON bp.id = cb.plan_id\nWHERE bp.\"businessId\" <> c.\"businessId\"\n\nUNION ALL\nSELECT\n  'VISITA_OTRO_NEGOCIO',\n  c.id, c.name, c.tag, c.\"createdAt\",\n  'Visit vinculado a cliente de este negocio, pero (sanity check) businessId del cliente ≠ bid (no debería salir)'\nFROM \"Visit\" v\nJOIN \"Customer\" c ON c.id = v.\"customerId\"\nWHERE c.\"businessId\" <> (SELECT bid FROM p)\n-- esta rama no debería devolver nada; queda como \"trip-wire\"\n;\n\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "AxiomaDB",
      "isAutoGenerated": false,
      "name": "AxiomaDB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "q_audit_clientes_business",
    "pageId": "Dashboard",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}