{
  "gitSyncId": "68f1ea66301c3b6f3e13c5f4_14120ba9-9086-489d-8bb5-acfbf2c8809f",
  "id": "Dashboard_q_assign_bond_plan",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH v AS (\n  SELECT\n    {{ this.params.customerId }}::uuid AS cid,   -- cliente destino\n    {{ this.params.planId     }}::uuid AS plan_id\n),\n\n-- Verifica que el plan exista y sea del mismo negocio que el cliente\nplan_ok AS (\n  SELECT 1 AS ok\n  FROM \"BondPlan\" bp\n  JOIN \"Customer\" c ON c.id = {{ this.params.customerId }}::uuid\n  WHERE bp.id = {{ this.params.planId }}::uuid\n    AND bp.\"businessId\" = c.\"businessId\"\n),\n\n-- Intento de UPDATE (si ya existe bond del cliente)\nupd AS (\n  UPDATE \"Bond\" b\n     SET \"planId\"    = v.plan_id,\n         status      = 'ACTIVE',\n         \"updatedAt\" = now()\n  FROM v, plan_ok\n  WHERE b.\"customerId\" = v.cid\n  RETURNING b.id, b.\"customerId\", b.\"planId\", b.status, b.\"startedAt\", b.\"createdAt\", b.\"updatedAt\"\n),\n\n-- Si no existía, INSERT\nins AS (\n  INSERT INTO \"Bond\"(id, \"customerId\", \"planId\", \"startedAt\", status)\n  SELECT uuid_generate_v4(), v.cid, v.plan_id, now(), 'ACTIVE'\n  FROM v, plan_ok\n  WHERE NOT EXISTS (SELECT 1 FROM upd)\n  RETURNING id, \"customerId\", \"planId\", status, \"startedAt\", \"createdAt\", \"updatedAt\"\n),\n\n-- Respuesta estándar si se actualiza o inserta\nresult AS (\n  SELECT TRUE AS plan_exists, TRUE AS updated, FALSE AS inserted,\n         id, \"customerId\", \"planId\", status, \"startedAt\", \"createdAt\", \"updatedAt\"\n  FROM upd\n  UNION ALL\n  SELECT TRUE, FALSE, TRUE,\n         id, \"customerId\", \"planId\", status, \"startedAt\", \"createdAt\", \"updatedAt\"\n  FROM ins\n),\n\n-- Fallback explícito: plan inexistente o de otro negocio → fila con flags en falso\nfallback AS (\n  SELECT FALSE AS plan_exists, FALSE AS updated, FALSE AS inserted,\n         NULL::uuid AS id, v.cid AS \"customerId\", v.plan_id AS \"planId\",\n         NULL::text AS status, NULL::timestamptz AS \"startedAt\",\n         NULL::timestamptz AS \"createdAt\", NULL::timestamptz AS \"updatedAt\"\n  FROM v\n  WHERE NOT EXISTS (SELECT 1 FROM plan_ok)\n)\n\n-- Entrega resultado si hubo acción; si no, entrega fallback\nSELECT * FROM result\nUNION ALL\nSELECT * FROM fallback\n;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "AxiomaDB",
      "isAutoGenerated": false,
      "name": "AxiomaDB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "q_assign_bond_plan",
    "pageId": "Dashboard",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}