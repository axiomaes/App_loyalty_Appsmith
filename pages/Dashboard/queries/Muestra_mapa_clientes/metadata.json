{
  "gitSyncId": "68f1ea66301c3b6f3e13c5f4_d857db75-3768-490b-a6e5-f2c0fdf5e32f",
  "id": "Dashboard_Muestra_mapa_clientes",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH audit AS (\n  -- pega aqu√≠ la misma consulta de arriba SIN el punto y coma final\n  WITH p AS (\n    SELECT {{ appsmith.store.businessId }}::uuid AS bid\n  ),\n  cust AS (\n    SELECT c.*, REGEXP_REPLACE(c.phone, '\\D', '', 'g') AS phone_norm\n    FROM \"Customer\" c\n    WHERE c.\"businessId\" = (SELECT bid FROM p)\n  ),\n  dup_phones AS (\n    SELECT phone_norm FROM cust\n    WHERE phone_norm IS NOT NULL AND phone_norm <> ''\n    GROUP BY phone_norm HAVING COUNT(*) > 1\n  ),\n  vip_tag AS (SELECT id FROM cust WHERE COALESCE(tag,'') ILIKE '%VIP%'),\n  cust_bond AS (\n    SELECT DISTINCT b.\"customerId\" AS customer_id, b.id AS bond_id, b.\"planId\" AS plan_id, b.status\n    FROM \"Bond\" b JOIN cust c ON c.id = b.\"customerId\"\n  ),\n  bond_plan AS (SELECT bp.* FROM \"BondPlan\" bp)\n  SELECT 'CLIENTE_ELIMINADO' AS issue FROM cust c WHERE c.\"deletedAt\" IS NOT NULL\n  UNION ALL\n  SELECT 'TAG_NULO_O_VACIO' FROM cust c WHERE c.tag IS NULL OR c.tag = ''\n  UNION ALL\n  SELECT 'TELEFONO_DUPLICADO' FROM cust c WHERE c.phone_norm IN (SELECT phone_norm FROM dup_phones)\n  UNION ALL\n  SELECT 'VIP_SIN_BONO' FROM cust c JOIN vip_tag v ON v.id = c.id\n           LEFT JOIN cust_bond cb ON cb.customer_id = c.id WHERE cb.customer_id IS NULL\n  UNION ALL\n  SELECT 'BONO_CON_PLAN_INACTIVO' FROM cust c JOIN cust_bond cb ON cb.customer_id = c.id\n           JOIN bond_plan bp ON bp.id = cb.plan_id WHERE COALESCE(bp.\"isActive\", TRUE) = FALSE\n  UNION ALL\n  SELECT 'BONO_STATUS_NO_ACTIVO' FROM cust c JOIN cust_bond cb ON cb.customer_id = c.id\n           WHERE COALESCE(cb.status,'') NOT IN ('ACTIVE','OPEN')\n  UNION ALL\n  SELECT 'BONDPLAN_OTRO_NEGOCIO' FROM cust c JOIN cust_bond cb ON cb.customer_id = c.id\n           JOIN bond_plan bp ON bp.id = cb.plan_id WHERE bp.\"businessId\" <> c.\"businessId\"\n)\nSELECT issue, COUNT(*)::int AS total\nFROM audit\nGROUP BY issue\nORDER BY total DESC, issue;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "AxiomaDB",
      "isAutoGenerated": false,
      "name": "AxiomaDB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "Muestra_mapa_clientes",
    "pageId": "Dashboard",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}