{
  "gitSyncId": "68f1ea66301c3b6f3e13c5f4_0e00f0a9-e326-4e51-b64b-295ffe863d32",
  "id": "Dashboard_q_crear_cliente",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH p AS (\n  SELECT\n    /* businessId: usa Auth.businessId() si existe; si no, store */\n    ({{ (Auth.businessId && Auth.businessId()) || appsmith.store.businessId }})::uuid AS bid\n),\n\ninput AS (\n  SELECT\n    p.bid                               AS \"businessId\",\n    NULLIF(TRIM({{ this.params.name }}::text), '')                  AS name,\n    /* normaliza: deja solo dígitos y toma los últimos 9; antepone +34 */\n    ('+34' || RIGHT(REGEXP_REPLACE({{ this.params.phone }}::text, '[^0-9]', '', 'g'), 9)) AS phone_norm,\n    NULLIF({{ this.params.email || null }}::text, '')              AS email,\n    NULLIF({{ this.params.notes || null }}::text, '')              AS notes,\n    /* acepta 'YYYY-MM-DD' o timestamp; guarda como date -> cast a timestamp si prefieres */\n    CASE\n      WHEN {{ this.params.birthday ? 'true' : 'false' }}\n      THEN ({{ this.params.birthday }}::date)::timestamp\n      ELSE NULL\n    END                                                            AS birthday,\n    /* tag como texto; por defecto 'NONE' si viene vacío/nulo */\n    COALESCE(NULLIF(TRIM({{ this.params.tag || 'NONE' }}::text), ''), 'NONE') AS tag,\n    now() AS \"updatedAt\"\n  FROM p\n),\n\n-- valida mínimos (businessId, name y phone)\nnorm AS (\n  SELECT *\n  FROM input\n  WHERE \"businessId\" IS NOT NULL\n    AND name IS NOT NULL\n    AND phone_norm IS NOT NULL\n),\n\n-- dedup por business + últimos 9 dígitos del teléfono (ignorando formato)\ndup AS (\n  SELECT c.id\n  FROM \"Customer\" c\n  JOIN norm n ON n.\"businessId\" = c.\"businessId\"\n  WHERE c.\"deletedAt\" IS NULL\n    AND RIGHT(REGEXP_REPLACE(c.phone, '[^0-9]', '', 'g'), 9)\n        = RIGHT(REGEXP_REPLACE(n.phone_norm, '[^0-9]', '', 'g'), 9)\n  LIMIT 1\n),\n\nins AS (\n  INSERT INTO \"Customer\"(\"businessId\", name, phone, email, notes, birthday, tag, \"updatedAt\")\n  SELECT n.\"businessId\", n.name, n.phone_norm, n.email, n.notes, n.birthday, n.tag, n.\"updatedAt\"\n  FROM norm n\n  WHERE NOT EXISTS (SELECT 1 FROM dup)\n  RETURNING id, \"businessId\", name, phone, email, notes, birthday, tag, \"createdAt\", \"updatedAt\"\n)\n\nSELECT\n  /* flags útiles para la UI */\n  EXISTS (SELECT 1 FROM p)                     AS has_bid,\n  (SELECT COUNT(*) FROM norm) > 0               AS has_min_fields,\n  EXISTS (SELECT 1 FROM dup)                    AS is_duplicate,\n  (SELECT id FROM dup)                          AS duplicate_id,\n  EXISTS (SELECT 1 FROM ins)                    AS inserted,\n  (SELECT to_jsonb(ins.*) FROM ins)             AS row,\n  (SELECT 'AXIOMA:VISIT:CID='||id::text FROM ins) AS qr_payload;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "AxiomaDB",
      "isAutoGenerated": false,
      "name": "AxiomaDB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "q_crear_cliente",
    "pageId": "Dashboard",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}