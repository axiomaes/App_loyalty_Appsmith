{
  "gitSyncId": "68f1ea66301c3b6f3e13c5f4_fc0b9808-9673-40ee-abec-a08291b16d6c",
  "id": "Dashboard_getClientVisitsQuery",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "-- Detecta si es VIP por el tag del cliente\nWITH is_vip AS (\n  SELECT\n    c.id AS customer_id,\n    (c.tag ILIKE '%VIP%') AS vip\n  FROM \"Customer\" c\n  WHERE c.id = {{ appsmith.store.selCustomerId }}::uuid\n  LIMIT 1\n),\nvip_counts AS (\n  -- Para VIP: 4 casillas por mes, sin recompensas\n  SELECT\n    i.customer_id,\n    4               AS total_slots,\n    date_trunc('month', now())       AS month_start,\n    date_trunc('month', now()) + interval '1 month' AS next_month_start,\n    COUNT(v.id)     AS visits_this_month\n  FROM is_vip i\n  LEFT JOIN \"Visit\" v\n    ON v.\"customerId\" = i.customer_id\n   AND v.\"visitedAt\" >= date_trunc('month', now())\n   AND v.\"visitedAt\"  < date_trunc('month', now()) + interval '1 month'\n  GROUP BY 1,2,3,4\n),\nlast_free AS (\n  -- Para no VIP: reinicio en la última FREE canjeada\n  SELECT\n    r.\"customerId\"    AS customer_id,\n    COALESCE(MAX(r.\"redeemedAt\"), '1970-01-01'::timestamptz) AS since\n  FROM \"Reward\" r\n  WHERE r.\"customerId\" = {{ appsmith.store.selCustomerId }}::uuid\n    AND r.kind = 'free'\n    AND r.status = 'REDEEMED'\n  GROUP BY 1\n),\nnormal_counts AS (\n  SELECT\n    c.id AS customer_id,\n    10   AS total_slots,\n    (SELECT since FROM last_free lf WHERE lf.customer_id = c.id) AS cycle_start,\n    (\n      SELECT COUNT(1)\n      FROM \"Visit\" v\n      WHERE v.\"customerId\" = c.id\n        AND v.\"visitedAt\" > COALESCE((SELECT since FROM last_free lf WHERE lf.customer_id = c.id),\n                                     '1970-01-01'::timestamptz)\n    ) AS visits_since\n  FROM \"Customer\" c\n  WHERE c.id = {{ appsmith.store.selCustomerId }}::uuid\n  LIMIT 1\n),\nrewards_state AS (\n  -- ¿Ya hay recompensas emitidas en el ciclo actual? (pendientes o canjeadas)\n  SELECT\n    c.id AS customer_id,\n    -- punto de inicio del ciclo\n    COALESCE((SELECT since FROM last_free lf WHERE lf.customer_id = c.id),\n             '1970-01-01'::timestamptz) AS since,\n    -- \"50%\" emitida en el ciclo\n    EXISTS (\n      SELECT 1 FROM \"Reward\" r\n      WHERE r.\"customerId\" = c.id\n        AND r.kind = 'half'\n        AND r.\"issuedAt\" > COALESCE((SELECT since FROM last_free lf WHERE lf.customer_id = c.id),\n                                    '1970-01-01'::timestamptz)\n    ) AS half_issued,\n    -- \"Gratis\" emitida en el ciclo\n    EXISTS (\n      SELECT 1 FROM \"Reward\" r\n      WHERE r.\"customerId\" = c.id\n        AND r.kind = 'free'\n        AND r.\"issuedAt\" > COALESCE((SELECT since FROM last_free lf WHERE lf.customer_id = c.id),\n                                    '1970-01-01'::timestamptz)\n    ) AS free_issued\n  FROM \"Customer\" c\n  WHERE c.id = {{ appsmith.store.selCustomerId }}::uuid\n  LIMIT 1\n)\nSELECT\n  -- planName informativo\n  CASE WHEN (SELECT vip FROM is_vip) THEN 'VIP' ELSE 'Default' END AS \"planName\",\n\n  -- totalSlots + currentVisits según VIP/normal\n  CASE WHEN (SELECT vip FROM is_vip)\n       THEN (SELECT total_slots FROM vip_counts)\n       ELSE (SELECT total_slots FROM normal_counts)\n  END AS \"totalSlots\",\n\n  CASE WHEN (SELECT vip FROM is_vip)\n       THEN (SELECT visits_this_month FROM vip_counts)\n       ELSE (SELECT visits_since FROM normal_counts)\n  END AS \"currentVisits\",\n\n  -- fecha de ciclo para normal (para VIP puedes devolver el inicio de mes)\n  CASE WHEN (SELECT vip FROM is_vip)\n       THEN date_trunc('month', now())\n       ELSE (SELECT cycle_start FROM normal_counts)\n  END AS \"cycleStart\",\n\n  -- flags de recompensas (solo relevantes en normal)\n  CASE WHEN (SELECT vip FROM is_vip) THEN FALSE ELSE (SELECT half_issued FROM rewards_state) END AS \"halfIssued\",\n  CASE WHEN (SELECT vip FROM is_vip) THEN FALSE ELSE (SELECT free_issued FROM rewards_state) END AS \"freeIssued\",\n\n  -- es VIP?\n  (SELECT vip FROM is_vip) AS \"isVip\";\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "AxiomaDB",
      "isAutoGenerated": false,
      "name": "AxiomaDB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "getClientVisitsQuery",
    "pageId": "Dashboard",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}