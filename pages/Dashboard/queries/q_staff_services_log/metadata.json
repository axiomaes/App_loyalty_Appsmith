{
  "gitSyncId": "68f1ea66301c3b6f3e13c5f4_b372e76d-ea9b-4a8a-8e29-05c0e8876cdb",
  "id": "Dashboard_q_staff_services_log",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH tz AS (\n  -- hora actual en Madrid\n  SELECT now() AT TIME ZONE 'Europe/Madrid' AS now_es\n),\n\n-- Parámetros de fecha desde / hasta (opcionales)\nparams AS (\n  SELECT\n    NULLIF({{ DateFrom_services.selectedDate || '' }}, '')::timestamptz AS d_from_raw,\n    NULLIF({{ DateTo_services.selectedDate   || '' }}, '')::timestamptz AS d_to_raw\n),\n\n-- Normalizamos rango [start_es, end_es) en horario Madrid\nbounds AS (\n  SELECT\n    COALESCE(\n      date_trunc('day', d_from_raw AT TIME ZONE 'Europe/Madrid'),\n      date_trunc('day', (SELECT now_es FROM tz))\n    ) AS start_es,\n    COALESCE(\n      date_trunc('day', d_to_raw AT TIME ZONE 'Europe/Madrid') + interval '1 day',\n      date_trunc('day', (SELECT now_es FROM tz)) + interval '1 day'\n    ) AS end_es\n  FROM params\n),\n\n-- Contexto de rol + email del usuario conectado\nctx AS (\n  SELECT\n    UPPER(\n      COALESCE(\n        NULLIF({{ typeof Auth?.role === 'function' ? Auth.role() : '' }}, ''),\n        NULLIF({{ appsmith.store?.role || '' }}, ''),\n        'BARBER'\n      )\n    ) AS role,\n    COALESCE(\n      NULLIF({{ appsmith.store?.userEmail || '' }}, ''),\n      NULLIF({{ typeof Auth?.email === 'function' ? Auth.email() : '' }}, ''),\n      NULLIF({{ appsmith.user?.email || '' }}, ''),\n      ''\n    ) AS email\n),\n\nbiz AS (\n  SELECT\n    COALESCE(\n      NULLIF({{ appsmith.store?.businessId || '' }}, ''),\n      NULLIF({{ typeof Auth?.businessId === 'function' ? Auth.businessId() : '' }}, '')\n    )::uuid AS business_id\n),\n\n-- Resolvemos el userId del staff a partir del email\nstaff AS (\n  SELECT u.id AS staff_id\n  FROM \"User\" u, biz, ctx\n  WHERE u.\"businessId\" = biz.business_id\n    AND lower(u.email) = lower(ctx.email)\n  LIMIT 1\n)\n\nSELECT\n  l.id,\n  l.\"visitedAt\" AT TIME ZONE 'Europe/Madrid' AS fecha_hora,\n  c.name        AS cliente,\n  c.phone       AS telefono,\n  COALESCE(l.\"serviceName\", s.name) AS servicio,\n  COALESCE(l.\"priceCents\", s.\"priceCents\") AS price_cents,\n  l.quantity,\n  u.email       AS staff_email,\n  u.\"role\"      AS staff_role\nFROM \"StaffServiceLog\" l\nJOIN biz\n  ON l.\"businessId\" = biz.business_id\nJOIN \"Customer\" c\n  ON c.id = l.\"customerId\"\nLEFT JOIN \"Service\" s\n  ON s.id = l.\"serviceId\"\nLEFT JOIN \"User\" u\n  ON u.id = l.\"staffUserId\"\nJOIN bounds b\n  ON l.\"visitedAt\" >= b.start_es AT TIME ZONE 'UTC'\n AND l.\"visitedAt\" <  b.end_es   AT TIME ZONE 'UTC'\nWHERE\n  (\n    -- ADMIN / OWNER / SUPERADMIN ven todo\n    (SELECT role FROM ctx) IN ('ADMIN','OWNER','SUPERADMIN')\n    -- BARBER y resto → solo sus propios servicios\n    OR (\n      (SELECT role FROM ctx) NOT IN ('ADMIN','OWNER','SUPERADMIN')\n      AND l.\"staffUserId\" = (SELECT staff_id FROM staff)\n    )\n  )\nORDER BY l.\"visitedAt\" DESC;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "AxiomaDB",
      "isAutoGenerated": false,
      "name": "AxiomaDB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "q_staff_services_log",
    "pageId": "Dashboard",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}