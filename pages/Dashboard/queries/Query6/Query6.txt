WITH tz AS (
  SELECT now() AT TIME ZONE 'Europe/Madrid' AS now_es
),
bounds AS (
  SELECT 
    -- límites del día de hoy en Madrid, convertidos a UTC
    (date_trunc('day', now_es) AT TIME ZONE 'Europe/Madrid')       AS start_utc,
    (date_trunc('day', now_es) + interval '1 day') AT TIME ZONE 'Europe/Madrid' AS end_utc
  FROM tz
),

-- Contexto robusto (sin concatenaciones)
ctx AS (
  SELECT
    UPPER(
      COALESCE(
        NULLIF({{ typeof Auth?.role === 'function' ? Auth.role() : '' }}, ''),
        NULLIF({{ appsmith.store?.role || '' }}, ''),
        'BARBER'
      )
    ) AS role,
    COALESCE(
      NULLIF({{ appsmith.store?.userEmail || '' }}, ''),
      NULLIF({{ typeof Auth?.email === 'function' ? Auth.email() : '' }}, ''),
      NULLIF({{ appsmith.user?.email || '' }}, ''),
      ''
    ) AS email
),

biz AS (
  SELECT
    COALESCE(
      NULLIF({{ appsmith.store?.businessId || '' }}, ''),
      NULLIF({{ typeof Auth?.businessId === 'function' ? Auth.businessId() : '' }}, '')
    )::uuid AS business_id
)

SELECT
  v.id,
  v."visitedAt" AT TIME ZONE 'Europe/Madrid' AS hora,
  c.name        AS cliente,
  c.phone       AS telefono,
  COALESCE(v.notes,'') AS notas,
  v."createdBy"       AS creado_por,
  COALESCE(
    bono.plan_name,
    CASE
      WHEN c.tag IS NULL OR c.tag = '' THEN 'Sin bono'
      ELSE initcap(replace(replace(lower(c.tag), '_', ' '), 'vip', 'VIP'))
    END
  ) AS tipo_bono
FROM "Visit" v
JOIN "Customer" c
  ON c.id = v."customerId"
LEFT JOIN LATERAL (
  SELECT bp.name AS plan_name
  FROM "Bond" b
  JOIN "BondPlan" bp
    ON bp.id = b."planId"
   AND bp."businessId" = c."businessId"
   AND bp."isActive" = TRUE
  WHERE b."customerId" = c.id
  ORDER BY b."startedAt" DESC
  LIMIT 1
) bono ON TRUE
JOIN bounds b
  -- interpretamos visitedAt como UTC y comparamos en UTC
  ON (v."visitedAt" AT TIME ZONE 'UTC') >= b.start_utc
 AND (v."visitedAt" AT TIME ZONE 'UTC') <  b.end_utc
WHERE c."businessId" = (SELECT business_id FROM biz)
  AND (
        (SELECT role FROM ctx) IN ('ADMIN','OWNER','SUPERADMIN')
        OR COALESCE(v."createdBy",'') = (SELECT email FROM ctx)
      )
ORDER BY v."visitedAt" DESC;
