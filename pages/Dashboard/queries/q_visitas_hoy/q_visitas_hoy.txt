WITH tz AS (
	SELECT now() AT TIME ZONE 'Europe/Madrid' AS now_es
),
bounds AS (
	SELECT date_trunc('day', now_es) AS start_es,
	date_trunc('day', now_es) + interval '1 day' AS end_es
	FROM tz
),
ctx AS (
	SELECT
	{{ appsmith.store?.session?.role || appsmith.store?.role || 'BARBER' }}::text AS role,
	{{ appsmith.user.email || '' }}::text AS email
)
SELECT
  v.id,
  v."visitedAt" AT TIME ZONE 'Europe/Madrid' AS hora,
  c.name        AS cliente,
  c.phone       AS telefono,
  COALESCE(v.notes,'') AS notas,
  v."createdBy"       AS creado_por,
  COALESCE(
		bono.plan_name,
		CASE
		WHEN c.tag IS NULL OR c.tag = '' THEN 'Sin bono'
		ELSE initcap(replace(replace(lower(c.tag), '_', ' '), 'vip', 'VIP'))
		END
	) AS tipo_bono
FROM "Visit" v
JOIN "Customer" c
  ON c.id = v."customerId"
LEFT JOIN LATERAL (
	SELECT bp.name AS plan_name
	FROM "Bond" b
	JOIN "BondPlan" bp
	ON bp.id = b."planId"
	AND bp."businessId" = c."businessId"
	AND bp."isActive" = TRUE
	WHERE b."customerId" = c.id
	ORDER BY b."startedAt" DESC
	LIMIT 1
) bono ON TRUE
JOIN bounds b
  ON v."visitedAt" >= b.start_es AT TIME ZONE 'UTC'
 AND v."visitedAt" <  b.end_es   AT TIME ZONE 'UTC'
-- ðŸ” VISIBILIDAD por rol
WHERE c."businessId" = {{ appsmith.store.businessId }}::uuid
  AND (
		(SELECT role FROM ctx) IN ('ADMIN','OWNER','SUPERADMIN')
		OR COALESCE(v."createdBy",'') = (SELECT email FROM ctx)
	)
ORDER BY v."visitedAt" DESC;
