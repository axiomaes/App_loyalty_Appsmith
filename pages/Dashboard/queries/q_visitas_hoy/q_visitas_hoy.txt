WITH tz AS (
	SELECT now() AT TIME ZONE 'Europe/Madrid' AS now_es
),
bounds AS (
	SELECT date_trunc('day', now_es) AS start_es,
	date_trunc('day', now_es) + interval '1 day' AS end_es
	FROM tz
),
-- Contexto robusto: no depende de appsmith.store.session
ctx AS (
	SELECT
	-- Rol: Auth.role() -> store.role -> 'BARBER'
	(
		{{ typeof Auth?.role === 'function' ? Auth.role() : '' }}
		||
		{{ appsmith.store?.role || '' }}
	)::text
	/* si todo vacÃ­o, default */ 
	AS role_raw,

	-- Email: store.userEmail -> Auth.email() -> appsmith.user.email -> ''
	(
		{{ appsmith.store?.userEmail || '' }}
		||
		{{ typeof Auth?.email === 'function' ? Auth.email() : '' }}
		||
		{{ appsmith.user?.email || '' }}
	)::text AS email_raw
),
ctx_norm AS (
	SELECT
	CASE
	WHEN trim(role_raw) IS NULL OR trim(role_raw) = '' THEN 'BARBER'
	ELSE upper(trim(role_raw))
	END AS role,
	trim(email_raw) AS email
	FROM ctx
),
biz AS (
	SELECT
	(
		{{ appsmith.store?.businessId || '' }}
		||
		{{ typeof Auth?.businessId === 'function' ? Auth.businessId() : '' }}
	)::uuid AS business_id
)

SELECT
  v.id,
  v."visitedAt" AT TIME ZONE 'Europe/Madrid' AS hora,
  c.name        AS cliente,
  c.phone       AS telefono,
  COALESCE(v.notes,'') AS notas,
  v."createdBy"       AS creado_por,
  COALESCE(
		bono.plan_name,
		CASE
		WHEN c.tag IS NULL OR c.tag = '' THEN 'Sin bono'
		ELSE initcap(replace(replace(lower(c.tag), '_', ' '), 'vip', 'VIP'))
		END
	) AS tipo_bono
FROM "Visit" v
JOIN "Customer" c
  ON c.id = v."customerId"
LEFT JOIN LATERAL (
	SELECT bp.name AS plan_name
	FROM "Bond" b
	JOIN "BondPlan" bp
	ON bp.id = b."planId"
	AND bp."businessId" = c."businessId"
	AND bp."isActive" = TRUE
	WHERE b."customerId" = c.id
	ORDER BY b."startedAt" DESC
	LIMIT 1
) bono ON TRUE
JOIN bounds b
  ON v."visitedAt" >= b.start_es AT TIME ZONE 'UTC'
 AND v."visitedAt" <  b.end_es   AT TIME ZONE 'UTC'
WHERE c."businessId" = (SELECT business_id FROM biz)
  AND (
		(SELECT role FROM ctx_norm) IN ('ADMIN','OWNER','SUPERADMIN')
		OR COALESCE(v."createdBy",'') = (SELECT email FROM ctx_norm)
	)
ORDER BY v."visitedAt" DESC;
