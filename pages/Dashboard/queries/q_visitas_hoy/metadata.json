{
  "gitSyncId": "68f1ea66301c3b6f3e13c5f4_832a3d0a-d019-41c8-be82-0481770ec195",
  "id": "Dashboard_q_visitas_hoy",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH tz AS (\n\tSELECT now() AT TIME ZONE 'Europe/Madrid' AS now_es\n),\nbounds AS (\n\tSELECT date_trunc('day', now_es) AS start_es,\n\tdate_trunc('day', now_es) + interval '1 day' AS end_es\n\tFROM tz\n),\nctx AS (\n\tSELECT\n\t{{ appsmith.store?.session?.role || appsmith.store?.role || 'BARBER' }}::text AS role,\n\t{{ appsmith.user.email || '' }}::text AS email\n)\nSELECT\n  v.id,\n  v.\"visitedAt\" AT TIME ZONE 'Europe/Madrid' AS hora,\n  c.name        AS cliente,\n  c.phone       AS telefono,\n  COALESCE(v.notes,'') AS notas,\n  v.\"createdBy\"       AS creado_por,\n  COALESCE(\n\t\tbono.plan_name,\n\t\tCASE\n\t\tWHEN c.tag IS NULL OR c.tag = '' THEN 'Sin bono'\n\t\tELSE initcap(replace(replace(lower(c.tag), '_', ' '), 'vip', 'VIP'))\n\t\tEND\n\t) AS tipo_bono\nFROM \"Visit\" v\nJOIN \"Customer\" c\n  ON c.id = v.\"customerId\"\nLEFT JOIN LATERAL (\n\tSELECT bp.name AS plan_name\n\tFROM \"Bond\" b\n\tJOIN \"BondPlan\" bp\n\tON bp.id = b.\"planId\"\n\tAND bp.\"businessId\" = c.\"businessId\"\n\tAND bp.\"isActive\" = TRUE\n\tWHERE b.\"customerId\" = c.id\n\tORDER BY b.\"startedAt\" DESC\n\tLIMIT 1\n) bono ON TRUE\nJOIN bounds b\n  ON v.\"visitedAt\" >= b.start_es AT TIME ZONE 'UTC'\n AND v.\"visitedAt\" <  b.end_es   AT TIME ZONE 'UTC'\n-- ðŸ” VISIBILIDAD por rol\nWHERE c.\"businessId\" = {{ appsmith.store.businessId }}::uuid\n  AND (\n\t\t(SELECT role FROM ctx) IN ('ADMIN','OWNER','SUPERADMIN')\n\t\tOR COALESCE(v.\"createdBy\",'') = (SELECT email FROM ctx)\n\t)\nORDER BY v.\"visitedAt\" DESC;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "AxiomaDB",
      "isAutoGenerated": false,
      "name": "AxiomaDB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "q_visitas_hoy",
    "pageId": "Dashboard",
    "runBehaviour": "AUTOMATIC",
    "userSetOnLoad": false
  }
}