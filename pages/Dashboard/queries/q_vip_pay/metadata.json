{
  "gitSyncId": "68f1ea66301c3b6f3e13c5f4_1061b14e-0249-4ea6-990f-66d6c4285168",
  "id": "Dashboard_q_vip_pay",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "WITH v AS (\n  SELECT\n    {{ this.params.customerId }}::uuid                                          AS cid,\n    COALESCE({{ this.params.period || null }}, to_char(now(),'YYYY-MM'))::text  AS period,\n    {{ this.params.amountCents }}::int                                          AS amount_cents,\n    {{ this.params.method || null }}::text                                      AS method,\n    {{ this.params.notes  || null }}::text                                      AS notes\n),\n\ncust AS (\n  SELECT c.id AS cid, c.tag::text AS tag\n  FROM \"Customer\" c\n  JOIN v ON c.id = v.cid\n),\n\nvip_check AS (\n  SELECT (tag ILIKE '%VIP%') AS is_vip FROM cust\n),\n\nbond AS (\n  SELECT b.id\n  FROM \"Bond\" b\n  JOIN v ON b.\"customerId\" = v.cid\n  LIMIT 1\n),\n\n-- Actualiza pago si ya existe en el mismo periodo\nupd AS (\n  UPDATE \"BondPayment\" bp\n  SET\n    \"amountCents\" = v.amount_cents,\n    \"paidAt\"      = now(),\n    method        = v.method,\n    notes         = v.notes\n  FROM v, bond b\n  WHERE bp.\"bondId\" = b.id\n    AND bp.period   = v.period\n  RETURNING 1 AS updated\n),\n\n-- Inserta pago nuevo si no exist√≠a\nins AS (\n  INSERT INTO \"BondPayment\"(id, \"bondId\", period, \"amountCents\", \"paidAt\", method, notes)\n  SELECT uuid_generate_v4(), b.id, v.period, v.amount_cents, now(), v.method, v.notes\n  FROM v, bond b\n  WHERE NOT EXISTS (SELECT 1 FROM upd)\n  RETURNING 1 AS inserted\n),\n\n-- Marca bono como activo si hubo movimiento\nmark_active AS (\n  UPDATE \"Bond\" bo\n  SET status = 'ACTIVE'\n  FROM bond b\n  WHERE bo.id = b.id\n    AND (EXISTS (SELECT 1 FROM upd) OR EXISTS (SELECT 1 FROM ins))\n  RETURNING 1 AS marked\n)\n\nSELECT\n  (SELECT NOT is_vip FROM vip_check)              AS not_vip,\n  (SELECT id IS NOT NULL FROM bond)               AS has_bond,\n  COALESCE((SELECT updated  FROM upd), 0)         AS updated,\n  COALESCE((SELECT inserted FROM ins), 0)         AS inserted,\n  COALESCE((SELECT marked   FROM mark_active), 0) AS bond_marked_active;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "AxiomaDB",
      "isAutoGenerated": false,
      "name": "AxiomaDB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "q_vip_pay",
    "pageId": "Dashboard",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}