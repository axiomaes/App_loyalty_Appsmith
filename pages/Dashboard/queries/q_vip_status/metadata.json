{
  "gitSyncId": "68f1ea66301c3b6f3e13c5f4_27dbc47a-4649-46f8-8e3e-9280d35730de",
  "id": "Dashboard_q_vip_status",
  "pluginId": "postgres-plugin",
  "pluginType": "DB",
  "unpublishedAction": {
    "actionConfiguration": {
      "body": "-- Requiere:\n--  this.params.customerId  (uuid)\n-- Asume tablas: \"Bond\" (con customerId) y \"BondPayment\" (con bondId)\n-- Cambia nombres si difieren en tu esquema.\n\nWITH vars AS (\n  SELECT\n    {{ this.params.customerId }}::uuid       AS cid,\n    date_trunc('month', now())               AS mstart,\n    to_char(now(), 'YYYY-MM')                AS period,\n    4                                         AS allowance  -- 4 atenciones / mes\n),\nbond AS (\n  SELECT b.id\n  FROM \"Bond\" b\n  WHERE b.\"customerId\" = (SELECT cid FROM vars)\n  LIMIT 1\n),\npaid AS (\n  SELECT bp.*\n  FROM \"BondPayment\" bp\n  JOIN bond ON bp.\"bondId\" = bond.id\n  WHERE bp.period = (SELECT period FROM vars)\n  ORDER BY bp.\"paidAt\" DESC\n  LIMIT 1\n),\nvisits AS (\n  SELECT count(*)::int AS used\n  FROM \"Visit\" v\n  WHERE v.\"customerId\" = (SELECT cid FROM vars)\n    AND v.\"visitedAt\" >= (SELECT mstart FROM vars)\n    AND v.\"visitedAt\" <  (SELECT mstart FROM vars) + interval '1 month'\n),\nres AS (\n  SELECT\n    (paid.id IS NOT NULL)                    AS active,           -- pagado en el mes\n    (SELECT period FROM vars)                AS period,\n    (SELECT used FROM visits)                AS used,\n    GREATEST(0, (SELECT allowance FROM vars) - (SELECT used FROM visits)) AS remaining,\n    paid.\"paidAt\",\n    paid.\"amountCents\",\n    paid.\"method\",\n    paid.\"notes\"\n  FROM paid\n  FULL JOIN visits ON TRUE\n)\nSELECT COALESCE(active, false) AS active,\n       period,\n       COALESCE(used, 0)       AS used,\n       COALESCE(remaining, 4)  AS remaining,\n       \"paidAt\",\"amountCents\",\"method\",\"notes\"\nFROM res;\n",
      "encodeParamsToggle": true,
      "paginationType": "NONE",
      "pluginSpecifiedTemplates": [
        {
          "value": true
        }
      ],
      "timeoutInMillisecond": 10000
    },
    "confirmBeforeExecute": false,
    "datasource": {
      "id": "AxiomaDB",
      "isAutoGenerated": false,
      "name": "AxiomaDB",
      "pluginId": "postgres-plugin"
    },
    "dynamicBindingPathList": [
      {
        "key": "body"
      }
    ],
    "name": "q_vip_status",
    "pageId": "Dashboard",
    "runBehaviour": "MANUAL",
    "userSetOnLoad": false
  }
}