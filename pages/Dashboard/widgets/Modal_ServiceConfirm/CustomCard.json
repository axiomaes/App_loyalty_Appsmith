{
  "backgroundColor": "#FFFFFF",
  "borderColor": "#E0DEDE",
  "borderRadius": "{{appsmith.theme.borderRadius.appBorderRadius}}",
  "borderWidth": "1",
  "bottomRow": 83,
  "boxShadow": "{{appsmith.theme.boxShadow.appBoxShadow}}",
  "defaultModel": "{{ appsmith.store.visitsUI || JS_VisitsFilter.processData() }}\n",
  "dynamicBindingPathList": [
    {
      "key": "theme"
    },
    {
      "key": "borderRadius"
    },
    {
      "key": "boxShadow"
    },
    {
      "key": "defaultModel"
    }
  ],
  "dynamicHeight": "AUTO_HEIGHT",
  "dynamicPropertyPathList": [
    {
      "key": "onAddVisit"
    }
  ],
  "dynamicTriggerPathList": [
    {
      "key": "onAddVisit"
    }
  ],
  "events": [
    "onAddVisit"
  ],
  "isCanvas": false,
  "isLoading": false,
  "isSearchWildcard": true,
  "isVisible": true,
  "key": "en7wr6rd6j",
  "leftColumn": 1,
  "maxDynamicHeight": 9000,
  "minDynamicHeight": 4,
  "mobileBottomRow": 31,
  "mobileLeftColumn": 38,
  "mobileRightColumn": 61,
  "mobileTopRow": 1,
  "needsErrorInfo": false,
  "onAddVisit": "{{ \n  (async () => {\n    await VisitAdd.manual();                       // tu lógica actual\n    await getClientVisitsQuery.run();              // refresca progreso\n    await getFallbackVisitsCount.run();            // por si aplica\n    await visitsLogic.processData();               // vuelve a llenar appsmith.store.visitsUI\n    await q_visitas_historial.run({\n      customerId: appsmith.store.selCustomerId,\n      limit: 500, offset: 0\n    });\n  })()\n}}\n",
  "originalBottomRow": 85,
  "originalTopRow": 59,
  "parentColumnSpace": 10.678878784179688,
  "parentId": "grbkir91px",
  "parentRowSpace": 10,
  "renderMode": "CANVAS",
  "rightColumn": 60,
  "shouldScrollContents": true,
  "srcDoc": {
    "css": "@charset \"UTF-8\";\n:root {\n  --card-bg: #ffffff;\n  --card-bdr: #e5e7eb;\n  --text: #111827;\n  --muted: #6b7280;\n  --blue: #3b82f6;\n  --gray-pill: #f3f4f6;\n  --green: #10b981;\n}\n\n* {\n  box-sizing: border-box;\n}\n\n.card {\n  background: var(--card-bg);\n  border: 1px solid var(--card-bdr);\n  border-radius: 14px;\n  padding: 16px;\n  color: var(--text);\n  width: 100%;\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n}\n\n.header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  gap: 12px;\n}\n\n.header h3 {\n  margin: 0;\n  font-size: 16px;\n  font-weight: 700;\n}\n\n.badges {\n  display: inline-flex;\n  gap: 8px;\n}\n\n.badge {\n  display: inline-flex;\n  align-items: center;\n  padding: 6px 10px;\n  border-radius: 999px;\n  font-size: 12px;\n  line-height: 1;\n  border: 1px solid transparent;\n}\n\n.badge-gray {\n  background: var(--gray-pill);\n  color: var(--text);\n}\n\n.badge-blue {\n  background: rgba(59, 130, 246, 0.12);\n  color: var(--blue);\n  border-color: rgba(59, 130, 246, 0.2);\n}\n\n.badge.done {\n  background: rgba(16, 185, 129, 0.12);\n  color: var(--green);\n  border-color: rgba(16, 185, 129, 0.2);\n}\n\n/* GRID */\n.grid {\n  display: grid;\n  grid-template-columns: repeat(5, 1fr); /* normal: 10 slots (5x2) */\n  gap: 12px;\n}\n\n/* si es VIP, el JS añade .vip al grid → 4 columnas */\n.grid.vip {\n  grid-template-columns: repeat(4, 1fr);\n}\n\n/* Slot */\n.slot {\n  display: grid;\n  place-items: center;\n  height: 56px;\n  border-radius: 12px;\n  border: 1px solid var(--card-bdr);\n  background: #f9fafb;\n  color: var(--muted);\n  font-weight: 600;\n  user-select: none;\n  cursor: default;\n  transition: transform 0.06s ease, background 0.2s ease, color 0.2s ease, border-color 0.2s ease;\n}\n\n.slot:hover {\n  transform: translateY(-1px);\n}\n\n.slot.active {\n  background: var(--blue);\n  color: white;\n  border-color: var(--blue);\n}\n\n.slot.done {\n  background: #ecfdf5;\n  color: var(--green);\n  border-color: rgba(16, 185, 129, 0.35);\n}",
    "html": "<div class=\"card\">\n  <div class=\"header\">\n    <h3 id=\"title\">Tarjeta de visitas</h3>\n    <div class=\"badges\">\n      <span id=\"badge50\"  class=\"badge badge-gray\" hidden>5 para 50%</span>\n      <span id=\"badgeFree\" class=\"badge badge-blue\"  hidden>10 para gratis</span>\n    </div>\n  </div>\n\n  <div id=\"grid\" class=\"grid\"></div>\n</div>\n",
    "js": "// ===== Colores (mismo esquema) ======================================\nconst COLORS = {\n  slotFilledBg: '#2F6FEB',\n  slotFilledText: '#FFFFFF',\n  slotEmptyBg: '#EEF2F7',\n  slotEmptyText: '#8A93A5',\n  badgeGrayBg: '#E5E7EB',\n  badgeGrayText: '#374151',\n  badgeGreenBg: '#D1FAE5',\n  badgeGreenText: '#065F46',\n  badgeBlueBg: '#DBEAFE',\n  badgeBlueText: '#1E40AF'\n};\n\n// Utilidad texto seguro\nconst txt = (v, def = '') => v == null ? def : String(v);\n\n// Dibuja \"pastilla\" (badge)\nfunction paintBadge(el, text, completed, theme /* 'green' | 'blue' | 'gray' */) {\n  if (!el) return;\n  if (!text) {\n    el.hidden = true;\n    el.style.display = 'none';\n    return;\n  }\n  el.hidden = false;\n  el.style.display = 'inline-block';\n  el.textContent = text;\n  let bg = COLORS.badgeGrayBg;\n  let fg = COLORS.badgeGrayText;\n  if (theme === 'green') {\n    bg = completed ? COLORS.badgeGreenBg : COLORS.badgeGrayBg;\n    fg = completed ? COLORS.badgeGreenText : COLORS.badgeGrayText;\n  } else if (theme === 'blue') {\n    bg = completed ? COLORS.badgeBlueBg : COLORS.badgeGrayBg;\n    fg = completed ? COLORS.badgeBlueText : COLORS.badgeGrayText;\n  }\n  el.style.background = bg;\n  el.style.color = fg;\n}\n\n// Botón de slot\nfunction createSlotButton(slot, model) {\n  const btn = document.createElement('button');\n  btn.className = 'slot';\n  btn.textContent = slot.value;\n  const filled = !!slot.filled;\n\n  // estilos\n  btn.style.background = filled ? COLORS.slotFilledBg : COLORS.slotEmptyBg;\n  btn.style.color = filled ? COLORS.slotFilledText : COLORS.slotEmptyText;\n  btn.style.border = '0';\n  btn.style.borderRadius = '14px';\n  btn.style.height = '64px';\n  btn.style.fontWeight = '700';\n  btn.style.fontSize = '18px';\n  btn.style.cursor = filled ? 'default' : 'pointer';\n  if (filled) {\n    btn.style.opacity = '0.9';\n    btn.style.pointerEvents = 'none'; // evita doble registro\n  }\n\n  // Click → registrar visita sólo si no está marcado\n  if (!filled) {\n    btn.addEventListener('click', () => {\n      appsmith.triggerEvent('onAddVisit', {\n        slot: slot.value,\n        model\n      });\n    });\n  }\n  return btn;\n}\n\n// Genera slots si no llegan desde el modelo\nfunction ensureSlots(current, total) {\n  const arr = [];\n  for (let i = 1; i <= total; i++) {\n    arr.push({\n      value: i,\n      filled: i <= (current || 0)\n    });\n  }\n  return arr;\n}\n\n// Render principal\nfunction render(model) {\n  const titleEl = document.getElementById('title');\n  const badge50El = document.getElementById('badge50');\n  const badgeFreeEl = document.getElementById('badgeFree');\n  const gridEl = document.getElementById('grid');\n  if (!titleEl || !badge50El || !badgeFreeEl || !gridEl) {\n    console.warn('[CustomCard] Faltan nodos: title, badge50, badgeFree, grid');\n    return;\n  }\n\n  // === Datos del modelo ===\n  const planName = txt(model.planName).toLowerCase();\n  const tagName = txt(model.tag).toLowerCase();\n  const currentVisits = Number(model.currentVisits || 0);\n  const isVip = Boolean(model.isVip) || /vip/i.test(planName) || /vip/i.test(tagName);\n\n  // total de casillas según VIP o no\n  // si viene del backend, lo respetamos; si no, default 4/10\n  const totalSlots = Number(model.totalSlots || (isVip ? 4 : 10));\n\n  // --- Textos adaptativos ---\n  let headerText = '';\n  let prizeFree = null; // solo usamos la de gratis\n\n  if (isVip) {\n    // usamos totalSlots como objetivo VIP si viene seteado\n    const target = totalSlots || 4;\n    const restantes = Math.max(target - currentVisits, 0);\n    headerText = currentVisits < target ? `VIP: ¡Solo ${restantes} visitas para el Gratis!` : '¡Premio VIP listo para canjear!';\n    prizeFree = {\n      text: `${target} para Servicio Gratis (VIP)`,\n      completed: currentVisits >= target\n    };\n  } else {\n    // objetivo normal = totalSlots o 10\n    const targetGratis = totalSlots || 10;\n    const restantes = Math.max(targetGratis - currentVisits, 0);\n    if (currentVisits < targetGratis) {\n      headerText = `¡Solo ${restantes} para Gratis!`;\n    } else {\n      headerText = '¡Premio Gratis listo para canjear!';\n    }\n    prizeFree = {\n      text: `${targetGratis} para Servicio Gratis`,\n      completed: currentVisits >= targetGratis\n    };\n  }\n\n  // --- Aplicar DOM ---\n  titleEl.textContent = headerText;\n\n  // Ocultamos badge 50% y sólo usamos la de Gratis\n  paintBadge(badge50El, '', false, 'green'); // se queda oculto\n  paintBadge(badgeFreeEl, prizeFree?.text || '', !!(prizeFree && prizeFree.completed), 'blue');\n\n  // --- Grilla de slots ---\n  const slots = Array.isArray(model.slots) && model.slots.length ? model.slots : ensureSlots(currentVisits, totalSlots || 10);\n  gridEl.innerHTML = '';\n  gridEl.style.display = 'grid';\n  gridEl.style.gap = '16px';\n  const cols = isVip ? 2 : Math.min(5, Math.max(2, totalSlots || slots.length || 10));\n  gridEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;\n  slots.forEach(s => gridEl.appendChild(createSlotButton(s, model)));\n}\n\n// Ciclo de vida del Custom Widget\nappsmith.onReady(() => {\n  render(appsmith.model || {});\n});\nappsmith.onModelChange = newModel => {\n  render(newModel || {});\n};"
  },
  "theme": "{{appsmith.theme}}",
  "topRow": 58,
  "type": "CUSTOM_WIDGET",
  "uncompiledSrcDoc": {
    "css": ":root {\n  --card-bg: #ffffff;\n  --card-bdr: #e5e7eb;\n  --text: #111827;\n  --muted: #6b7280;\n  --blue: #3b82f6;\n  --gray-pill: #f3f4f6;\n  --green: #10b981;\n}\n\n* { box-sizing: border-box; }\n\n.card {\n  background: var(--card-bg);\n  border: 1px solid var(--card-bdr);\n  border-radius: 14px;\n  padding: 16px;\n  color: var(--text);\n  width: 100%;\n  height: 100%;\n  display: flex;\n  flex-direction: column;\n  gap: 12px;\n}\n\n.header {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  gap: 12px;\n}\n\n.header h3 {\n  margin: 0;\n  font-size: 16px;\n  font-weight: 700;\n}\n\n.badges {\n  display: inline-flex;\n  gap: 8px;\n}\n\n.badge {\n  display: inline-flex;\n  align-items: center;\n  padding: 6px 10px;\n  border-radius: 999px;\n  font-size: 12px;\n  line-height: 1;\n  border: 1px solid transparent;\n}\n\n.badge-gray {\n  background: var(--gray-pill);\n  color: var(--text);\n}\n\n.badge-blue {\n  background: rgba(59,130,246,.12);\n  color: var(--blue);\n  border-color: rgba(59,130,246,.2);\n}\n\n.badge.done {\n  background: rgba(16,185,129,.12);\n  color: var(--green);\n  border-color: rgba(16,185,129,.2);\n}\n\n/* GRID */\n.grid {\n  display: grid;\n  grid-template-columns: repeat(5, 1fr); /* normal: 10 slots (5x2) */\n  gap: 12px;\n}\n\n/* si es VIP, el JS añade .vip al grid → 4 columnas */\n.grid.vip {\n  grid-template-columns: repeat(4, 1fr);\n}\n\n/* Slot */\n.slot {\n  display: grid;\n  place-items: center;\n  height: 56px;\n  border-radius: 12px;\n  border: 1px solid var(--card-bdr);\n  background: #f9fafb;\n  color: var(--muted);\n  font-weight: 600;\n  user-select: none;\n  cursor: default;\n  transition: transform .06s ease, background .2s ease, color .2s ease, border-color .2s ease;\n}\n\n.slot:hover { transform: translateY(-1px); }\n\n.slot.active {\n  background: var(--blue);\n  color: white;\n  border-color: var(--blue);\n}\n\n.slot.done {\n  background: #ecfdf5;\n  color: var(--green);\n  border-color: rgba(16,185,129,.35);\n}\n",
    "html": "<div class=\"card\">\n  <div class=\"header\">\n    <h3 id=\"title\">Tarjeta de visitas</h3>\n    <div class=\"badges\">\n      <span id=\"badge50\"  class=\"badge badge-gray\" hidden>5 para 50%</span>\n      <span id=\"badgeFree\" class=\"badge badge-blue\"  hidden>10 para gratis</span>\n    </div>\n  </div>\n\n  <div id=\"grid\" class=\"grid\"></div>\n</div>\n",
    "js": "// ===== Colores (mismo esquema) ======================================\nconst COLORS = {\n  slotFilledBg:  '#2F6FEB',\n  slotFilledText:'#FFFFFF',\n  slotEmptyBg:   '#EEF2F7',\n  slotEmptyText: '#8A93A5',\n\n  badgeGrayBg:   '#E5E7EB',\n  badgeGrayText: '#374151',\n\n  badgeGreenBg:  '#D1FAE5',\n  badgeGreenText:'#065F46',\n\n  badgeBlueBg:   '#DBEAFE',\n  badgeBlueText: '#1E40AF',\n};\n\n// Utilidad texto seguro\nconst txt = (v, def = '') => (v == null ? def : String(v));\n\n// Dibuja \"pastilla\" (badge)\nfunction paintBadge(el, text, completed, theme /* 'green' | 'blue' | 'gray' */) {\n  if (!el) return;\n  if (!text) {\n    el.hidden = true;\n    el.style.display = 'none';\n    return;\n  }\n  el.hidden = false;\n  el.style.display = 'inline-block';\n  el.textContent = text;\n\n  let bg = COLORS.badgeGrayBg;\n  let fg = COLORS.badgeGrayText;\n\n  if (theme === 'green') {\n    bg = completed ? COLORS.badgeGreenBg : COLORS.badgeGrayBg;\n    fg = completed ? COLORS.badgeGreenText : COLORS.badgeGrayText;\n  } else if (theme === 'blue') {\n    bg = completed ? COLORS.badgeBlueBg : COLORS.badgeGrayBg;\n    fg = completed ? COLORS.badgeBlueText : COLORS.badgeGrayText;\n  }\n\n  el.style.background = bg;\n  el.style.color = fg;\n}\n\n// Botón de slot\nfunction createSlotButton(slot, model) {\n  const btn = document.createElement('button');\n  btn.className = 'slot';\n  btn.textContent = slot.value;\n\n  const filled = !!slot.filled;\n\n  // estilos\n  btn.style.background = filled ? COLORS.slotFilledBg : COLORS.slotEmptyBg;\n  btn.style.color      = filled ? COLORS.slotFilledText : COLORS.slotEmptyText;\n  btn.style.border = '0';\n  btn.style.borderRadius = '14px';\n  btn.style.height = '64px';\n  btn.style.fontWeight = '700';\n  btn.style.fontSize = '18px';\n  btn.style.cursor = filled ? 'default' : 'pointer';\n\n  if (filled) {\n    btn.style.opacity = '0.9';\n    btn.style.pointerEvents = 'none'; // evita doble registro\n  }\n\n  // Click → registrar visita sólo si no está marcado\n  if (!filled) {\n    btn.addEventListener('click', () => {\n      appsmith.triggerEvent('onAddVisit', { slot: slot.value, model });\n    });\n  }\n\n  return btn;\n}\n\n// Genera slots si no llegan desde el modelo\nfunction ensureSlots(current, total) {\n  const arr = [];\n  for (let i = 1; i <= total; i++) {\n    arr.push({ value: i, filled: i <= (current || 0) });\n  }\n  return arr;\n}\n\n// Render principal\nfunction render(model) {\n  const titleEl    = document.getElementById('title');\n  const badge50El  = document.getElementById('badge50');\n  const badgeFreeEl= document.getElementById('badgeFree');\n  const gridEl     = document.getElementById('grid');\n\n  if (!titleEl || !badge50El || !badgeFreeEl || !gridEl) {\n    console.warn('[CustomCard] Faltan nodos: title, badge50, badgeFree, grid');\n    return;\n  }\n\n  // === Datos del modelo ===\n  const planName      = txt(model.planName).toLowerCase();\n  const tagName       = txt(model.tag).toLowerCase();\n  const currentVisits = Number(model.currentVisits || 0);\n  const isVip         =\n    Boolean(model.isVip) ||\n    /vip/i.test(planName) ||\n    /vip/i.test(tagName);\n\n  // total de casillas según VIP o no\n  // si viene del backend, lo respetamos; si no, default 4/10\n  const totalSlots = Number(\n    model.totalSlots ||\n    (isVip ? 4 : 10)\n  );\n\n  // --- Textos adaptativos ---\n  let headerText = '';\n  let prizeFree = null; // solo usamos la de gratis\n\n  if (isVip) {\n    // usamos totalSlots como objetivo VIP si viene seteado\n    const target = totalSlots || 4;\n    const restantes = Math.max(target - currentVisits, 0);\n\n    headerText =\n      currentVisits < target\n        ? `VIP: ¡Solo ${restantes} visitas para el Gratis!`\n        : '¡Premio VIP listo para canjear!';\n\n    prizeFree = {\n      text: `${target} para Servicio Gratis (VIP)`,\n      completed: currentVisits >= target,\n    };\n  } else {\n    // objetivo normal = totalSlots o 10\n    const targetGratis = totalSlots || 10;\n    const restantes = Math.max(targetGratis - currentVisits, 0);\n\n    if (currentVisits < targetGratis) {\n      headerText = `¡Solo ${restantes} para Gratis!`;\n    } else {\n      headerText = '¡Premio Gratis listo para canjear!';\n    }\n\n    prizeFree = {\n      text: `${targetGratis} para Servicio Gratis`,\n      completed: currentVisits >= targetGratis,\n    };\n  }\n\n  // --- Aplicar DOM ---\n  titleEl.textContent = headerText;\n\n  // Ocultamos badge 50% y sólo usamos la de Gratis\n  paintBadge(badge50El, '', false, 'green'); // se queda oculto\n  paintBadge(\n    badgeFreeEl,\n    prizeFree?.text || '',\n    !!(prizeFree && prizeFree.completed),\n    'blue',\n  );\n\n  // --- Grilla de slots ---\n  const slots =\n    Array.isArray(model.slots) && model.slots.length\n      ? model.slots\n      : ensureSlots(currentVisits, totalSlots || 10);\n\n  gridEl.innerHTML = '';\n  gridEl.style.display = 'grid';\n  gridEl.style.gap = '16px';\n\n  const cols = isVip\n    ? 2\n    : Math.min(5, Math.max(2, totalSlots || slots.length || 10));\n\n  gridEl.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;\n\n  slots.forEach((s) => gridEl.appendChild(createSlotButton(s, model)));\n}\n\n// Ciclo de vida del Custom Widget\nappsmith.onReady(() => {\n  render(appsmith.model || {});\n});\n\nappsmith.onModelChange = (newModel) => {\n  render(newModel || {});\n};\n"
  },
  "version": 1,
  "widgetId": "wwfln6ihu5",
  "widgetName": "CustomCard"
}